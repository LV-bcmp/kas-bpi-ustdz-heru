<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kas BPI Ustadz Heru</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0; padding: 0;
        background: #f4f4f9;
        position: relative;
        min-height: 100vh;
    }
    header {
        background: #004080;
        color: white;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
    }
    header-left {
        display: flex;
        align-items: center;
    }
    header img {
        height: 50px;
        margin-right: 15px;
    }
    header h1 {
        font-size: 1.5rem;
        margin: 0;
    }
    #userNameDisplay {
        margin-top: 5px;
        font-weight: bold;
        font-size: 1.1rem;
        color: #e0e0e0;
    }
    nav {
        background: #0066cc;
        display: flex;
        justify-content: center;
    }
    nav button {
        background: transparent;
        border: none;
        color: white;
        padding: 15px 25px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.3s;
    }
    nav button:hover, nav button.active {
        background: #004080;
    }
    main {
        padding: 20px;
        max-width: 600px;
        margin: 20px auto 40px auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 10px #ccc;
        min-height: 300px;
    }
    label {
        display: block;
        margin-top: 10px;
    }
    input[type=text], input[type=password], input[type=number] {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        box-sizing: border-box;
    }
    button.submit-btn {
        margin-top: 15px;
        background: #004080;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 1rem;
        border-radius: 4px;
    }
    button.submit-btn:hover {
        background: #003060;
    }
    .message {
        margin-top: 15px;
        font-weight: bold;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    th {
        background: #004080;
        color: white;
    }
    #calendarTime {
        position: absolute;
        top: 10px;
        right: 20px;
        color: white;
        font-weight: bold;
        font-size: 0.9rem;
        text-align: right;
        user-select: none;
        font-family: monospace;
    }
</style>
</head>
<body>
<header>
    <div style="display:flex; align-items:center;">
        <img src="https://smpitnurhidayah.dsd.co.id/asa/img/smpitnurhidayah.png" alt="Logo SMPIT Nur Hidayah Surakarta" />
        <div>
            <h1>Kas BPI Ustadz Heru</h1>
            <div id="userNameDisplay"></div>
        </div>
    </div>
    <div id="calendarTime"></div>
</header>
<nav id="navMenu" style="display:none;">
    <button id="authBtn" class="active">Login</button>
    <button id="bayarBtn">Bayar Kas</button>
    <button id="totalBtn">Total Kas Semua Murid</button>
</nav>
<main>
    <!-- Authenticating -->
    <section id="authSection">
        <h2>Login</h2>
        <label for="username">Username:</label>
        <input type="text" id="username" placeholder="Masukkan username" />
        <label for="password">Password:</label>
        <input type="password" id="password" placeholder="Masukkan password" />
        <button class="submit-btn" onclick="login()">Login</button>
        <div class="message" id="authMessage"></div>
    </section>

    <!-- Bayar Kas -->
    <section id="bayarSection" style="display:none;">
        <h2>Bayar Kas</h2>
        <p>Selamat datang, <span id="userDisplay"></span></p>
        <label for="amount">Bayar Kas (Rp) - kelipatan 5.000 (5k = 1 minggu):</label>
        <input type="number" id="amount" min="5000" step="5000" placeholder="Masukkan jumlah bayar (kelipatan 5000)" />
        <button class="submit-btn" onclick="bayarKas()">Bayar</button>
        <div class="message" id="bayarMessage"></div>
        <div class="message" id="warningMessage" style="color:red; font-weight:bold; margin-top:20px;"></div>
        <button class="submit-btn" style="margin-top:20px; background:#888;" onclick="logout()">Logout</button>
    </section>

    <!-- Total Kas Semua Murid -->
    <section id="totalSection" style="display:none;">
        <h2>Total Kas Semua Murid</h2>
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Nama</th>
                    <th>Total Kas (Rp)</th>
                    <th>Minggu Terbayar</th>
                </tr>
            </thead>
            <tbody id="kasTableBody">
                <!-- Data akan muncul di sini -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2" style="font-weight:bold; text-align:right;">Total kas saat ini :</td>
                    <td id="totalKasAll" colspan="2" style="font-weight:bold;">Rp0</td>
                </tr>
            </tfoot>
        </table>
    </section>
</main>

<script>
    // Key LocalStorage
    const STORAGE_KEY = 'kasMuridData';

    // Data murid default (username = password)
    const defaultMuridData = [
        { username: "01", password: "010101", nama: "ALIF FAUZAN PERDANA", kas: 0, mingguTerbayar: 0 },
        { username: "02", password: "020202", nama: "AHNAF KURNIA RADITYA", kas: 0, mingguTerbayar: 0 },
        { username: "03", password: "030303", nama: "FARHAN MUKTI WIBOWO", kas: 0, mingguTerbayar: 0 },
        { username: "04", password: "040404", nama: "GIOVANI PUTRA LAKSANA", kas: 0, mingguTerbayar: 0 },
        { username: "05", password: "050505", nama: "HAIDAR AMNAN HAWARI", kas: 0, mingguTerbayar: 0 },
        { username: "06", password: "060606", nama: "IBRAHIM RAZAN", kas: 0, mingguTerbayar: 0 },
        { username: "07", password: "070707", nama: "ZAKY AMALUL ARIFIN ADITYA", kas: 0, mingguTerbayar: 0 }
    ];

    // Ambil data murid dari LocalStorage atau pakai default
    function loadMuridData() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
            try {
                return JSON.parse(data);
            } catch {
                return [...defaultMuridData];
            }
        } else {
            return [...defaultMuridData];
        }
    }

    // Simpan data murid ke LocalStorage
    function saveMuridData(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    let muridData = loadMuridData();
    let loggedInUser   = null;

    // Navigasi menu
    const navMenu = document.getElementById('navMenu');
    const authBtn = document.getElementById('authBtn');
    const bayarBtn = document.getElementById('bayarBtn');
    const totalBtn = document.getElementById('totalBtn');

    const authSection = document.getElementById('authSection');
    const bayarSection = document.getElementById('bayarSection');
    const totalSection = document.getElementById('totalSection');

    const userNameDisplay = document.getElementById('userNameDisplay');
    const userDisplay = document.getElementById('userDisplay');
    const bayarMessage = document.getElementById('bayarMessage');
    const warningMessage = document.getElementById('warningMessage');
    const authMessage = document.getElementById('authMessage');

    authBtn.addEventListener('click', () => {
        setActiveMenu(authBtn);
        showSection(authSection);
    });
    bayarBtn.addEventListener('click', () => {
        if (!loggedInUser ) {
            alert("Silakan login terlebih dahulu!");
            setActiveMenu(authBtn);
            showSection(authSection);
            return;
        }
        setActiveMenu(bayarBtn);
        showSection(bayarSection);
        userDisplay.textContent = loggedInUser .nama;
        bayarMessage.textContent = "";
        warningMessage.textContent = "";
        document.getElementById('amount').value = "";
        checkPaymentStatus();
    });
    totalBtn.addEventListener('click', () => {
        if (!loggedInUser ) {
            alert("Silakan login terlebih dahulu!");
            setActiveMenu(authBtn);
            showSection(authSection);
            return;
        }
        setActiveMenu(totalBtn);
        showSection(totalSection);
        renderKasTable();
    });

    function setActiveMenu(activeBtn) {
        [authBtn, bayarBtn, totalBtn].forEach(btn => btn.classList.remove('active'));
        activeBtn.classList.add('active');
    }

    function showSection(section) {
        [authSection, bayarSection, totalSection].forEach(sec => sec.style.display = 'none');
        section.style.display = 'block';
    }

    // Reset kas dan mingguTerbayar jika belum bayar >= 35 minggu
    function resetIfOverdue(user, mingguSekarang) {
        const belumBayar = mingguSekarang - user.mingguTerbayar;
        if (belumBayar >= 35) {
            user.kas = 0;
            user.mingguTerbayar = 0;
            // Update di muridData dan simpan
            const idx = muridData.findIndex(m => m.username === user.username);
            if (idx !== -1) {
                muridData[idx].kas = 0;
                muridData[idx].mingguTerbayar = 0;
                saveMuridData(muridData);
            }
        }
    }

    // Fungsi login
    function login() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        // Refresh data murid dari storage agar up to date
        muridData = loadMuridData();

        const user = muridData.find(m => m.username === username && m.password === password);
        if (user) {
            // Hitung minggu sekarang
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const diffDays = Math.floor((now - startOfYear) / (1000 * 60 * 60 * 24));
            const mingguSekarang = Math.floor(diffDays / 7) + 1;

            resetIfOverdue(user, mingguSekarang);

            loggedInUser  = user;
            authMessage.style.color = 'green';
            authMessage.textContent = `Login berhasil! Selamat datang, ${user.nama}.`;
            navMenu.style.display = 'flex';
            userNameDisplay.textContent = user.nama;
            setActiveMenu(bayarBtn);
            showSection(bayarSection);
            userDisplay.textContent = loggedInUser .nama;
            bayarMessage.textContent = "";
            warningMessage.textContent = "";
            document.getElementById('amount').value = "";
            checkPaymentStatus();
        } else {
            authMessage.style.color = 'red';
            authMessage.textContent = "Username atau password salah!";
        }
    }

    // Fungsi bayar kas
    function bayarKas() {
        const amountInput = document.getElementById('amount');
        const amount = parseInt(amountInput.value);

        if (!amount || amount <= 0) {
            bayarMessage.style.color = 'red';
            bayarMessage.textContent = "Masukkan jumlah bayar yang valid!";
            return;
        }
        if (amount % 5000 !== 0) {
            bayarMessage.style.color = 'red';
            bayarMessage.textContent = "Jumlah bayar harus kelipatan 5.000!";
            return;
        }

        // Update data loggedInUser  di muridData
        const userIndex = muridData.findIndex(m => m.username === loggedInUser .username);
        if (userIndex !== -1) {
            muridData[userIndex].kas += amount;
            muridData[userIndex].mingguTerbayar += amount / 5000;

            // Update loggedInUser  juga
            loggedInUser .kas = muridData[userIndex].kas;
            loggedInUser .mingguTerbayar = muridData[userIndex].mingguTerbayar;

            // Simpan ke LocalStorage
            saveMuridData(muridData);

            bayarMessage.style.color = 'green';
            bayarMessage.textContent = `Pembayaran kas sebesar Rp${amount.toLocaleString()} berhasil! Total kas Anda sekarang Rp${loggedInUser .kas.toLocaleString()}.`;

            amountInput.value = "";
            warningMessage.textContent = "";
        } else {
            bayarMessage.style.color = 'red';
            bayarMessage.textContent = "Terjadi kesalahan, user tidak ditemukan!";
        }
    }

    // Fungsi logout
    function logout() {
        loggedInUser  = null;
        authMessage.textContent = "";
        userNameDisplay.textContent = "";
        document.getElementById('username').value = "";
        document.getElementById('password').value = "";
        navMenu.style.display = 'none';
        setActiveMenu(authBtn);
        showSection(authSection);
    }

    // Render tabel total kas semua murid
    function renderKasTable() {
        // Ambil data terbaru dari LocalStorage
        muridData = loadMuridData();

        const tbody = document.getElementById('kasTableBody');
        tbody.innerHTML = "";
        let totalKas = 0;
        muridData.forEach(m => {
            totalKas += m.kas;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${m.username}</td>
                <td>${m.nama}</td>
                <td>Rp${m.kas.toLocaleString()}</td>
                <td>${m.mingguTerbayar}</td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('totalKasAll').textContent = `Rp${totalKas.toLocaleString()}`;
    }

    // Fungsi cek status pembayaran minggu
    function checkPaymentStatus() {
        const now = new Date();
        const startOfYear = new Date(now.getFullYear(), 0, 1);
        const diffDays = Math.floor((now - startOfYear) / (1000 * 60 * 60 * 24));
        const mingguSekarang = Math.floor(diffDays / 7) + 1;

        resetIfOverdue(loggedInUser , mingguSekarang);

        const belumBayar = mingguSekarang - loggedInUser .mingguTerbayar;
        if (belumBayar > 0) {
            warningMessage.textContent = `ANDA BELUM MEMBAYAR KAS SELAMA ${belumBayar} MINGGU`;
        } else {
            warningMessage.textContent = "";
        }
    }

    // Kalender dan waktu realtime
    function updateCalendarTime() {
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateStr = now.toLocaleDateString('id-ID', options);
        const timeStr = now.toLocaleTimeString('id-ID');
        document.getElementById('calendarTime').textContent = `${dateStr} - ${timeStr}`;
    }

    setInterval(updateCalendarTime, 1000);
    updateCalendarTime();

    // Saat halaman dimuat, tampilkan hanya authSection dan sembunyikan menu
    window.onload = () => {
        navMenu.style.display = 'none';
        setActiveMenu(authBtn);
        showSection(authSection);
    };
</script>
</body>
</html>
